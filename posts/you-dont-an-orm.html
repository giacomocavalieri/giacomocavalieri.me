<!doctype html>
<html lang="en"><head><title>You don&#39;t need an ORM</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"><link rel="alternate" type="application/rss+xml" title="giacomocavalieri.me posts feed" href="https://giacomocavalieri.me/feed.xml"><meta property="og:site_name" content="Giacomo Cavalieri&#39;s blog"><meta property="og:title" content="You don&#39;t need an ORM"><meta property="og:type" content="website"><meta property="og:description" content><meta name="description" content><meta property="twitter:card" content="summary"><meta property="twitter:title" content="You don&#39;t need an ORM"><meta property="twitter:description" content><meta property="twitter:creator" content="@giacomo_cava"><link rel="payload" href="Mona-Sans.woff2" as="font" type="font/woff2" crossorigin="true"><meta name="theme-color" content="#cceac3" media="(prefers-color-scheme: light)"><link rel="stylesheet" href="/style.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script><script src="/highlightjs-gleam.js"></script><script>hljs.highlightAll();</script></head><body><div class="limit-max-width-and-center"><article class="post h-entry"><header><h1 class="post-title p-name">You don&#39;t need an ORM</h1><nav class="breadcrumbs"><a rel="author" href="/" class="breadcrumb-link">â† home</a></nav><div class="post-subtitle"><time datetime="2025-01-03" class="post-date dt-published">3 January 2025</time><ul class="post-tags"><li class="post-tag p-category"><a href="/tags/gleam.html">gleam</a></li><li class="post-tag p-category"><a href="/tags/orm.html">orm</a></li><li class="post-tag p-category"><a href="/tags/sql.html">sql</a></li><li class="post-tag p-category"><a href="/tags/squirrel.html">squirrel</a></li></ul></div></header><main class="post-body e-content"><p>For the last five months I&#39;ve been working on a really cool project called
<a href="https://github.com/giacomocavalieri/squirrel">squirrel</a>: a package to do type
safe SQL in Gleam.</p><div class="post-heading h2-title"><a href="#type-safe?" id="type-safe?" class="clip">ğŸ”—</a><h2>Type safe?</h2></div><p>Gleam is a statically typed language, everything must have a type and the
compiler, like a tireless and very thorough pair programmer, will make sure we
don&#39;t mix things up when coding.</p><p>Data that comes from the outside world, untyped by nature, is usually given the
<code>Dynamic</code> type. The only thing you can do with <code>Dynamic</code> data is decode it
turning it into something with a known shape your application can actually work
with.</p><p>This really nicely draws a clear dividing line ...</p><p>As a small example:</p><blockquote><p>Mandatory &quot;parse, don&#39;t validate&quot; recommendation</p></blockquote><blockquote><p><code>decode</code> is a really nice package that exposes a nice API to write decoders,
at the time of writing it&#39;s just an exploration that might make its way into
stdlib.</p></blockquote><p>This has quite some problems:</p><ol><li><p>The experience of writing the SQL is really bad. That is just a plain Gleam
String, so no syntax highlight, no suggestions, no auto completions, no auto
formatting, no nothing!</p></li><li><p>What if I want to inspect the query? What if I want to tune the query
performance? What if I want to use the query somewhere else?
What I&#39;ll have to do is copy paste the content of this Gleam string and feed
it to my dbms of choice.</p></li><li><p>What it the shape of my data changes? What if I realise I need to also fetch
another field (make an example a field to the select list).
I add it to the query and... nothing happens</p></li><li><p>What if I add a new query parameter?</p></li><li><p>What if I change the type of a query parameter? ... my code breaks at runtime</p></li></ol><p>How do we fix this? How can we make the developer experience better here?</p><div class="post-heading h3-title"><a href="#non-solution:-orm" id="non-solution:-orm" class="clip">ğŸ”—</a><h3>Non solution: ORM</h3></div><p>I don&#39;t particularly like ORMs</p><div class="post-heading h3-title"><a href="#non-solution:-query-builders" id="non-solution:-query-builders" class="clip">ğŸ”—</a><h3>Non solution: query builders</h3></div><p>Query builders are way cooler but I really</p><div class="post-heading h2-title"><a href="#enter-squirrel" id="enter-squirrel" class="clip">ğŸ”—</a><h2>Enter Squirrel</h2></div><p>So what now?</p><div class="post-heading h3-title"><a href="#it-just-worksâ„¢ï¸" id="it-just-worksâ„¢ï¸" class="clip">ğŸ”—</a><h3>It just worksâ„¢ï¸</h3></div><ul><li><p>It&#39;s just SQL, I love this</p></li><li><p>You get all the niceties of proper SQL tools</p></li><li><p>You can reuse your queries, no awkard copy-pasting</p></li><li><p>It&#39;s type safe and easy to keep in sync with your database</p></li><li><p>The DBMS knows best!! It has all the reliable type information about your
database</p></li></ul><blockquote><p>Ok I know, I know</p></blockquote><div class="post-heading h2-title"><a href="#how-does-it-do-its-magic" id="how-does-it-do-its-magic" class="clip">ğŸ”—</a><h2>How does it do its magic</h2></div><p>Making Squirrel was a real challenge</p><ul><li><p>Reading through sqlx, Rust is really hard for me, folks on Discord were really
helpful</p></li><li><p>Reading the Postgres docs, those are <em>excellent</em> but it can still be quite
challenging to get the protocol right</p></li><li><p>Just fuck around and find out</p></li></ul><p>And there&#39;s also loads of other things that are super interesting to me: how do
I generate pretty printed Gleam code, how can I make the error messages as nice
as possible, ...</p><p>I want to share some of the gory details I learned, one because I think it&#39;s a
lot of fun. Two because this is the kind of material I&#39;d have absolutely loved
to have when I started implementing Squirrel. Hopefully someone in the future
might have a head start when they&#39;ll try to implement the same thing in their
favourite language of choice.</p><div class="post-heading h3-title"><a href="#how-does-one-talk-to-postgres?" id="how-does-one-talk-to-postgres?" class="clip">ğŸ”—</a><h3>How does one talk to Postgres?</h3></div><div class="post-heading h3-title"><a href="#the-frontend/backend-protocol" id="the-frontend/backend-protocol" class="clip">ğŸ”—</a><h3>The frontend/backend protocol</h3></div><div class="post-heading h3-title"><a href="#code-generation" id="code-generation" class="clip">ğŸ”—</a><h3>Code generation</h3></div><p>Generating rubbish code is simple enough, but I wanted the generated Gleam code
to be as nice as possible, indistinguishable from carefully hand crafted code.
So the file is organised in neat sections, different functions reuse the same
code helpers that are neatly grouped at the end of the file.</p><p>Code is commented and most of all <em>formatted.</em>
A pretty printer is your best ally here.</p><div class="post-heading h3-title"><a href="#error-messages" id="error-messages" class="clip">ğŸ”—</a><h3>Error messages</h3></div><p>One of the thing I love most about languages like Gleam, Elm and Rust are the
lovely error messages. So one of the first things I started pondering was, how
can I make the error messages the best they can be?
Just like with code generation, a pretty printer is a real life saver here.
(Show the nice tooltips and wrapping text...)</p></main></article></div></body></html>